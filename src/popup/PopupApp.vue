<template>
  <div class="popup-container" :class="{ 'dark': isDarkMode }">
    <!-- Ê†áÈ¢òÊ†è -->
    <header class="header">
      <div class="header-left">
        <div class="logo">
          <span class="logo-icon">‚ö°</span>
          <span class="logo-text">Smart Tab</span>
        </div>
      </div>
      <div class="header-right">
        <button @click="openSettings" class="icon-button settings-btn" :title="t('popup.settings.title')">
          <FontAwesomeIcon icon="cog" class="w-5 h-5" />
        </button>
        <button @click="handleLanguageToggle" class="icon-button language-btn" :title="t('popup.language.switch')">
          <FontAwesomeIcon icon="globe" class="w-5 h-5" />
          <span class="language-text">{{ currentLanguage === 'zh-CN' ? 'EN' : '‰∏≠' }}</span>
        </button>
      </div>
    </header>

    <!-- ÊêúÁ¥¢Ê†è -->
    <div class="search-section">
      <div class="search-container" @click="openCommandPalette">
        <FontAwesomeIcon icon="search" class="search-icon w-4 h-4" />
        <input 
          type="text" 
          :placeholder="t('popup.search.placeholder')"
          class="search-input"
          readonly
        />
        <kbd class="search-shortcut">{{ t('popup.search.shortcut') }}</kbd>
      </div>
    </div>

    <!-- Ê¶ÇËßàÂç°Áâá -->
    <div class="overview-section">
      <div class="section-title">
        <FontAwesomeIcon icon="chart-bar" class="w-4 h-4" />
        <span>{{ t('popup.overview.title') }}</span>
      </div>
      <div class="overview-card">
        <div class="stat-item">
          <span class="stat-value">{{ stats.totalTabs }}</span>
          <span class="stat-label">{{ t('popup.overview.totalTabs') }}</span>
        </div>
        <div class="stat-item">
          <span class="stat-value duplicate">{{ stats.duplicateTabs }}</span>
          <span class="stat-label">{{ t('popup.overview.duplicates') }}</span>
        </div>
        <div class="stat-item">
          <span class="stat-value">‚ö°</span>
          <span class="stat-label">{{ formatTime(stats.lastSyncTime) }}</span>
        </div>
      </div>
    </div>

    <!-- Ê†áÁ≠æÈ°µÁÆ°ÁêÜ -->
    <div class="tabs-section">
      <div class="section-title">
        <FontAwesomeIcon icon="copy" class="w-4 h-4" />
        <span>{{ t('popup.tabs.title') }}</span>
        <span class="section-count">{{ currentTabs.length }}</span>
        <button 
          class="tab-sort-btn"
          @click="toggleTabSort"
          :title="getSortButtonTitle()"
        >
          <span class="sort-icon">{{ tabSortMode === 'time' ? 'üïê' : (tabSortMode === 'domain' ? 'üåê' : 'üìÇ') }}</span>
        </button>
      </div>
      
      <!-- Ê†áÁ≠æÈ°µËøáÊª§Âô® -->
      <div class="tab-filters" v-if="currentTabs.length > 10">
        <button 
          v-for="filter in tabFilters" 
          :key="filter.key"
          class="filter-btn"
          :class="{ 'active': activeTabFilter === filter.key }"
          @click="setTabFilter(filter.key)"
        >
          <span class="filter-icon">{{ filter.icon }}</span>
          <span class="filter-label">{{ filter.label }}</span>
          <span class="filter-count">{{ getFilteredTabsCount(filter.key) }}</span>
        </button>
      </div>
      
      <div class="tabs-list-container">
        <div class="tabs-list">
          <!-- ÊåâÂàÜÁªÑÊòæÁ§∫Ê†áÁ≠æÈ°µ -->
          <template v-if="tabSortMode === 'group'">
            <div v-for="group in groupedTabs" :key="group.name" class="tab-group">
              <div class="tab-group-header">
                <span class="group-name">{{ group.name }}</span>
                <span class="group-count">{{ group.tabs.length }}</span>
              </div>
              <div class="tab-group-items">
                <div 
                  v-for="tab in group.tabs" 
                  :key="`tab-${tab.id}-${tab.url}`"
                  class="tab-item"
                  :class="{
                    'active': tab.active,
                    'duplicate': isDuplicate(tab),
                    'pinned': tab.pinned
                  }"
                  @click="switchToTab(tab)"
                >
                  <img 
                    :src="getFaviconUrl(tab.favicon)" 
                    :alt="tab.title"
                    class="tab-favicon"
                    @error="handleFaviconError"
                  />
                  <div class="tab-info">
                    <span class="tab-title">{{ truncateText(tab.title, 25) }}</span>
                    <span class="tab-url">{{ getDomain(tab.url) }}</span>
                  </div>
                  <div class="tab-indicators">
                    <span v-if="tab.pinned" class="tab-indicator pinned" title="Â∑≤Âõ∫ÂÆö">üìå</span>
                    <span v-if="tab.active" class="tab-indicator active" title="ÂΩìÂâçÊ¥ªË∑É">‚óè</span>
                    <span v-if="isDuplicate(tab)" class="tab-indicator duplicate" title="ÈáçÂ§çÈ°µÈù¢">‚ö†Ô∏è</span>
                  </div>
                  <div class="tab-actions">
                    <button 
                      v-if="isDuplicate(tab)" 
                      class="tab-action duplicate"
                      @click.stop="handleDuplicate(tab)"
                      title="Â§ÑÁêÜÈáçÂ§çÈ°µÈù¢"
                    >
                      <FontAwesomeIcon icon="exclamation-triangle" class="w-3 h-3" />
                    </button>
                    <button 
                      class="tab-action workspace"
                      @click.stop="addToWorkspace(tab)"
                      title="Ê∑ªÂä†Âà∞ÂàÜÁªÑ"
                    >
                      <FontAwesomeIcon icon="plus" class="w-3 h-3" />
                    </button>
                    <button 
                      class="tab-action close"
                      @click.stop="closeTab(tab)"
                      :title="t('popup.tabs.closeTab')"
                    >
                      <span class="close-icon">√ó</span>
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </template>
          
          <!-- Â∏∏ËßÑÂàóË°®ÊòæÁ§∫ -->
          <template v-else>
            <div 
              v-for="tab in sortedAndFilteredTabs" 
              :key="`tab-${tab.id}-${tab.url}`"
              class="tab-item"
              :class="{
                'active': tab.active,
                'duplicate': isDuplicate(tab),
                'pinned': tab.pinned
              }"
              @click="switchToTab(tab)"
            >
              <img 
                :src="getFaviconUrl(tab.favicon)" 
                :alt="tab.title"
                class="tab-favicon"
                @error="handleFaviconError"
                @load="handleFaviconLoad"
              />
              <div class="tab-info">
                <span class="tab-title">{{ truncateText(tab.title, 25) }}</span>
                <span class="tab-url">{{ getDomain(tab.url) }}</span>
              </div>
              <div class="tab-indicators">
                <span v-if="tab.pinned" class="tab-indicator pinned" title="Â∑≤Âõ∫ÂÆö">üìå</span>
                <span v-if="tab.active" class="tab-indicator active" title="ÂΩìÂâçÊ¥ªË∑É">‚óè</span>
                <span v-if="isDuplicate(tab)" class="tab-indicator duplicate" title="ÈáçÂ§çÈ°µÈù¢">‚ö†Ô∏è</span>
              </div>
              <div class="tab-actions">
                <button 
                  v-if="isDuplicate(tab)" 
                  class="tab-action duplicate"
                  @click.stop="handleDuplicate(tab)"
                  title="Â§ÑÁêÜÈáçÂ§çÈ°µÈù¢"
                >
                  <FontAwesomeIcon icon="exclamation-triangle" class="w-3 h-3" />
                </button>
                <button 
                  class="tab-action workspace"
                  @click.stop="addToWorkspace(tab)"
                  title="Ê∑ªÂä†Âà∞ÂàÜÁªÑ"
                >
                  <FontAwesomeIcon icon="plus" class="w-3 h-3" />
                </button>
                <button 
                  class="tab-action close"
                  @click.stop="closeTab(tab)"
                  :title="t('popup.tabs.closeTab')"
                >
                  <span class="close-icon">√ó</span>
                </button>
              </div>
            </div>
          </template>
        </div>
        
        <div v-if="sortedAndFilteredTabs.length === 0 && currentTabs.length > 0" class="empty-state">
          <FontAwesomeIcon icon="copy" class="w-8 h-8 opacity-50" />
          <span>Ê≤°ÊúâÁ¨¶ÂêàÊù°‰ª∂ÁöÑÊ†áÁ≠æÈ°µ</span>
        </div>
        
        <div v-if="currentTabs.length === 0" class="empty-state">
          <FontAwesomeIcon icon="copy" class="w-8 h-8 opacity-50" />
          <span>ÊöÇÊó†Ê†áÁ≠æÈ°µ</span>
        </div>
      </div>
    </div>

    <!-- ÂàÜÁªÑ -->
    <div class="workspaces-section">
      <div class="section-title">
        <FontAwesomeIcon icon="folder" class="w-4 h-4" />
        <span>{{ t('popup.workspaces.title') }}</span>
      </div>
      <div class="workspaces-list">
        <div 
          v-for="workspace in workspaces.slice(0, 4)" 
          :key="workspace.id"
          class="workspace-item"
          :class="{ 'active': workspace.id === activeWorkspaceId }"
          @click="showWorkspaceTabsDialog(workspace)"
        >
          <div class="workspace-icon" :style="{ backgroundColor: workspace.color }">
            {{ workspace.icon }}
          </div>
          <div class="workspace-info">
            <span class="workspace-name">{{ workspace.name }}</span>
            <span class="workspace-count">({{ workspace.tabs.length }})</span>
          </div>
          <div class="workspace-activity">
            <div class="activity-bar">
              <div 
                class="activity-progress" 
                :style="{ width: `${getWorkspaceActivity(workspace)}%` }"
              ></div>
            </div>
          </div>
          <div class="workspace-actions">
            <button 
              class="workspace-action"
              @click.stop="openWorkspace(workspace)"
              :title="isI18nReady ? t('popup.workspaces.open') : 'ÊâìÂºÄÂàÜÁªÑ'"
            >
              <FontAwesomeIcon icon="play" class="w-3 h-3" />
            </button>
            <button 
              class="workspace-action"
              @click.stop="editWorkspace(workspace)"
              :title="isI18nReady ? t('popup.workspaces.edit') : 'ÁºñËæëÂàÜÁªÑ'"
            >
              <FontAwesomeIcon icon="edit" class="w-3 h-3" />
            </button>
            <button 
              class="workspace-action delete"
              @click.stop="deleteWorkspace(workspace)"
              :title="isI18nReady ? t('popup.workspaces.delete') : 'Âà†Èô§ÂàÜÁªÑ'"
            >
              <FontAwesomeIcon icon="trash" class="w-3 h-3" />
            </button>
          </div>
        </div>
        <button class="add-workspace-btn" @click="createWorkspace">
          <FontAwesomeIcon icon="plus" class="w-4 h-4" />
          <span>{{ t('popup.workspaces.newWorkspace') }}</span>
        </button>
      </div>
    </div>

    <!-- Âø´ÈÄüÊìç‰Ωú -->
    <div class="tabs-actions-section">
      <div class="section-title">
        <FontAwesomeIcon icon="plus" class="w-4 h-4" />
        <span>{{ t('popup.tabActions.title') }}</span>
      </div>
      <div class="tab-actions-grid">
        <button class="tab-action-btn" @click="createNewTab">
          <FontAwesomeIcon icon="plus" class="w-4 h-4" />
          <span>{{ t('popup.tabActions.newTab') }}</span>
        </button>
        <button class="tab-action-btn" @click="duplicateCurrentTab">
          <FontAwesomeIcon icon="copy" class="w-4 h-4" />
          <span>{{ t('popup.tabActions.duplicateTab') }}</span>
        </button>
      </div>
    </div>

    <!-- Á≥ªÁªüÊìç‰Ωú -->
    <div class="actions-section">
      <div class="section-title">
        <FontAwesomeIcon icon="bolt" class="w-4 h-4" />
        <span>{{ t('popup.systemActions.title') }}</span>
      </div>
      <div class="actions-grid">
        <button class="action-btn" @click="syncNow">
          <FontAwesomeIcon icon="cloud-upload-alt" class="w-4 h-4" />
          <span>{{ t('popup.systemActions.sync') }}</span>
        </button>
        <button class="action-btn" @click="createSnapshot">
          <FontAwesomeIcon icon="camera" class="w-4 h-4" />
          <span>{{ t('popup.systemActions.snapshot') }}</span>
        </button>
        <button class="action-btn" @click="restoreSession">
          <FontAwesomeIcon icon="sync" class="w-4 h-4" />
          <span>{{ t('popup.systemActions.restore') }}</span>
        </button>
        <button class="action-btn" @click="cleanDuplicates">
          <FontAwesomeIcon icon="trash" class="w-4 h-4" />
          <span>{{ t('popup.systemActions.cleanup') }}</span>
        </button>
      </div>
    </div>

    <!-- ÂëΩ‰ª§Èù¢Êùø -->
    <CommandPalette 
      v-if="showCommandPalette" 
      @close="showCommandPalette = false"
      @execute="executeCommand"
    />

    <!-- ÂàÜÁªÑÈÄâÊã©ÂØπËØùÊ°Ü -->
    <div v-if="showWorkspaceSelectorDialog" class="workspace-selector-overlay" @click="showWorkspaceSelectorDialog = false">
      <div class="workspace-selector-dialog" @click.stop>
        <h3>{{ t('popup.workspaces.selector.title') }}</h3>
        <p class="dialog-desc">{{ t('popup.workspaces.selector.description').replace('{title}', selectedTabForWorkspace?.title || '') }}</p>
        <div class="workspace-list">
          <div 
            v-for="workspace in workspaces" 
            :key="workspace.id"
            class="workspace-option"
            @click="selectWorkspaceForTab(workspace)"
          >
            <div class="workspace-icon" :style="{ backgroundColor: workspace.color }">
              {{ workspace.icon }}
            </div>
            <div class="workspace-info">
              <span class="workspace-name">{{ workspace.name }}</span>
              <span class="workspace-count">{{ workspace.tabs.length }} {{ t('popup.workspaces.selector.tabsCount') }}</span>
            </div>
          </div>
        </div>
        <div class="dialog-actions">
          <button class="btn-cancel" @click="showWorkspaceSelectorDialog = false">{{ t('popup.workspaces.selector.cancel') }}</button>
        </div>
      </div>
    </div>

    <!-- ÈáçÂ§çÈ°µÈù¢Ê∏ÖÁêÜÂØπËØùÊ°Ü -->
    <div v-if="showCleanupDialog" class="workspace-selector-overlay" @click="showCleanupDialog = false">
      <div class="workspace-selector-dialog cleanup-dialog" @click.stop>
        <h3>{{ t('popup.cleanup.dialog.title') }}</h3>
        <p class="dialog-desc">{{ t('popup.cleanup.dialog.description').replace('{count}', duplicateGroups.length.toString()) }}</p>
        
        <div class="duplicate-preview">
          <div v-for="(group, index) in duplicateGroups.slice(0, 3)" :key="index" class="duplicate-group">
            <div class="group-title">
              <span class="group-icon">üîó</span>
              <span>{{ truncateText(group.tabs[0]?.title || 'Êú™Áü•È°µÈù¢', 25) }}</span>
              <span class="duplicate-count">({{ group.tabs.length }}{{ t('popup.cleanup.dialog.groupCount') }})</span>
            </div>
            <div class="tabs-preview">
              <div v-for="(tab, tabIndex) in group.tabs.slice(0, 2)" :key="tab.id" class="tab-preview">
                <span class="tab-status" :class="{ 'keep': tabIndex === 0, 'close': tabIndex > 0 }">
                  {{ tabIndex === 0 ? t('popup.cleanup.dialog.keep') : t('popup.cleanup.dialog.close') }}
                </span>
                <span class="tab-domain">{{ getDomain(tab.url) }}</span>
              </div>
              <div v-if="group.tabs.length > 2" class="more-tabs">
                {{ t('popup.cleanup.dialog.moreTabs').replace('{count}', (group.tabs.length - 2).toString()) }}
              </div>
            </div>
          </div>
          <div v-if="duplicateGroups.length > 3" class="more-groups">
            {{ t('popup.cleanup.dialog.moreGroups').replace('{count}', (duplicateGroups.length - 3).toString()) }}
          </div>
        </div>

        <div class="dialog-actions">
          <button class="btn-cancel" @click="showCleanupDialog = false">{{ t('popup.cleanup.dialog.cancel') }}</button>
          <button class="btn-danger" @click="confirmCleanDuplicates">{{ t('popup.cleanup.dialog.confirm') }}</button>
        </div>
      </div>
    </div>

    <!-- ‰ºöËØùÊÅ¢Â§çÂØπËØùÊ°Ü -->
    <div v-if="showRestoreDialog" class="workspace-selector-overlay" @click="showRestoreDialog = false">
      <div class="workspace-selector-dialog workspace-tabs-dialog" @click.stop>
        <h3>{{ isI18nReady ? t('popup.systemActions.restoreDialog.title') : 'ÊÅ¢Â§ç‰ºöËØù' }}</h3>
        <p class="dialog-desc">{{ isI18nReady ? t('popup.systemActions.restoreDialog.description') : 'ÈÄâÊã©Ë¶ÅÊÅ¢Â§çÁöÑ‰ºöËØùÂø´ÁÖß' }}</p>
        
        <div class="workspace-tabs-list">
          <div v-if="availableSnapshots.length === 0" class="no-tabs">
            <FontAwesomeIcon icon="folder-open" class="w-8 h-8 opacity-50" />
            <span>{{ isI18nReady ? t('popup.systemActions.restoreDialog.noSnapshots') : 'ÊöÇÊó†ÂèØÁî®Âø´ÁÖß' }}</span>
          </div>
          <div 
            v-for="snapshot in availableSnapshots" 
            :key="snapshot.id"
            class="workspace-tab-item"
          >
            <div class="tab-icon">
              <FontAwesomeIcon icon="camera" class="w-4 h-4" />
            </div>
            <div class="tab-info">
              <span class="tab-title">{{ snapshot.name }}</span>
              <span class="tab-url">{{ formatSnapshotTime(snapshot.timestamp) }}</span>
              <span class="tab-url" v-if="snapshot.metadata?.totalTabs">
                {{ snapshot.metadata.totalTabs }} {{ isI18nReady ? t('popup.systemActions.restoreDialog.tabsCount') : '‰∏™Ê†áÁ≠æÈ°µ' }}
              </span>
            </div>
            <div class="tab-actions">
              <button 
                class="tab-action-btn open"
                @click="restoreFromSnapshot(snapshot)"
                :title="isI18nReady ? t('popup.systemActions.restoreDialog.restoreButton') : 'ÊÅ¢Â§çÂø´ÁÖß'"
              >
                <FontAwesomeIcon icon="sync" class="w-3 h-3" />
              </button>
              <button 
                class="tab-action-btn remove"
                @click="deleteSnapshot(snapshot)"
                :title="isI18nReady ? t('popup.systemActions.restoreDialog.deleteButton') : 'Âà†Èô§Âø´ÁÖß'"
              >
                <FontAwesomeIcon icon="trash" class="w-3 h-3" />
              </button>
            </div>
          </div>
        </div>

        <div class="dialog-actions">
          <button class="btn-cancel" @click="showRestoreDialog = false">
            {{ isI18nReady ? t('popup.systemActions.restoreDialog.cancel') : 'ÂèñÊ∂à' }}
          </button>
        </div>
      </div>
    </div>

    <!-- ÂàÜÁªÑÊ†áÁ≠æÂàóË°®ÂØπËØùÊ°Ü -->
    <div v-if="showWorkspaceTabsDialogVisible" class="workspace-selector-overlay" @click="showWorkspaceTabsDialogVisible = false">
      <div class="workspace-selector-dialog workspace-tabs-dialog" @click.stop>
        <h3>{{ isI18nReady ? t('popup.workspaces.tabsDialog.title') : 'ÂàÜÁªÑÊ†áÁ≠æÂàóË°®' }}</h3>
        <p class="dialog-desc">{{ getWorkspaceDialogDescription() }}</p>
        
        <div class="workspace-tabs-list">
          <div v-if="!selectedWorkspaceForTabs?.tabs.length" class="no-tabs">
            <FontAwesomeIcon icon="folder-open" class="w-8 h-8 opacity-50" />
            <span>{{ isI18nReady ? t('popup.workspaces.tabsDialog.emptyTabs') : 'ÊöÇÊó†Ê†áÁ≠æÈ°µ' }}</span>
          </div>
          <div 
            v-for="tab in selectedWorkspaceForTabs?.tabs" 
            :key="tab.url"
            class="workspace-tab-item"
          >
            <div class="tab-icon">
              <img v-if="tab.favicon" :src="tab.favicon" class="w-4 h-4" />
              <FontAwesomeIcon v-else icon="globe" class="w-4 h-4 opacity-50" />
            </div>
            <div class="tab-info">
              <span class="tab-title">{{ tab.title }}</span>
              <span class="tab-url">{{ tab.url }}</span>
            </div>
            <div class="tab-actions">
              <button 
                class="tab-action-btn open"
                @click="openTabFromWorkspace(tab)"
                :title="isI18nReady ? t('popup.workspaces.tabsDialog.openTab') : 'ÊâìÂºÄÊ†áÁ≠æ'"
              >
                <FontAwesomeIcon icon="external-link-alt" class="w-3 h-3" />
              </button>
              <button 
                class="tab-action-btn remove"
                @click="removeTabFromWorkspace(selectedWorkspaceForTabs!, tab)"
                :title="isI18nReady ? t('popup.workspaces.tabsDialog.removeTab') : 'ÁßªÈô§Ê†áÁ≠æ'"
              >
                <FontAwesomeIcon icon="trash" class="w-3 h-3" />
              </button>
            </div>
          </div>
        </div>

        <div class="dialog-actions">
          <button class="btn-primary" @click="openWorkspace(selectedWorkspaceForTabs!)">
            {{ isI18nReady ? t('popup.workspaces.open') : 'ÊâìÂºÄÂàÜÁªÑ' }}
          </button>
          <button class="btn-cancel" @click="showWorkspaceTabsDialogVisible = false">
            {{ isI18nReady ? t('popup.workspaces.tabsDialog.close') : 'ÂÖ≥Èó≠' }}
          </button>
        </div>
      </div>
    </div>

    <!-- ÈÄöÁü• -->
    <Notification 
      v-if="notification"
      :notification="notification"
      @close="notification = null"
    />
  </div>
</template>

<script setup lang="ts">
import { ref, reactive, onMounted, onUnmounted, computed, nextTick } from 'vue'
import { FontAwesomeIcon } from '@/utils/fontawesome'

import CommandPalette from '@/components/CommandPalette.vue'
import Notification from '@/components/Notification.vue'

import type { TabInfo, Workspace, Stats, Notification as NotificationType } from '@/types'
import { workspaceManager } from '@/utils/workspace-manager'
import { syncManager } from '@/utils/sync-manager'
import { duplicateDetector } from '@/utils/duplicate-detector'
import { useI18n } from '@/utils/i18n'

// Â§öËØ≠Ë®ÄÊîØÊåÅ
const { t, currentLanguage, toggleLanguage, initLanguage } = useI18n()

// Â§öËØ≠Ë®ÄÂàùÂßãÂåñÁä∂ÊÄÅ
const isI18nReady = ref(false)

// ÂìçÂ∫îÂºèÊï∞ÊçÆ
const isDarkMode = ref(false)
const showCommandPalette = ref(false)
const notification = ref<NotificationType | null>(null)
const activeWorkspaceId = ref<string | null>(null)

const stats = reactive({
  totalTabs: 0,
  duplicateTabs: 0,
  totalWorkspaces: 0,
  lastSyncTime: 0 // ÂàùÂßãÂåñ‰∏∫0ÔºåË°®Á§∫Êú™ÂêåÊ≠•
})

const currentTabs = ref<TabInfo[]>([])
const workspaces = ref<Workspace[]>([])
const duplicateTabs = ref<Set<string>>(new Set())

// Ê†áÁ≠æÈ°µÊéíÂ∫èÂíåËøáÊª§
const tabSortMode = ref<'time' | 'domain' | 'group'>('time')
const activeTabFilter = ref<'all' | 'active' | 'pinned' | 'duplicate'>('all')

const tabSortLabels = computed(() => {
  if (!isI18nReady.value) {
    return {
      time: 'Êó∂Èó¥ÊéíÂ∫è',
      domain: 'ÂüüÂêçÊéíÂ∫è', 
      group: 'ÂàÜÁªÑÊòæÁ§∫'
    }
  }
  
  try {
    return {
      time: t('popup.tabs.sortTime') || 'Êó∂Èó¥ÊéíÂ∫è',
      domain: t('popup.tabs.sortDomain') || 'ÂüüÂêçÊéíÂ∫è', 
      group: t('popup.tabs.sortGroup') || 'ÂàÜÁªÑÊòæÁ§∫'
    }
  } catch (error) {
    return {
      time: 'Êó∂Èó¥ÊéíÂ∫è',
      domain: 'ÂüüÂêçÊéíÂ∫è', 
      group: 'ÂàÜÁªÑÊòæÁ§∫'
    }
  }
})

const tabFilters = computed(() => {
  if (!isI18nReady.value) {
    return [
      { key: 'all', label: 'ÂÖ®ÈÉ®', icon: 'üìÑ' },
      { key: 'active', label: 'Ê¥ªË∑É', icon: '‚óè' },
      { key: 'pinned', label: 'Âõ∫ÂÆö', icon: 'üìå' },
      { key: 'duplicate', label: 'ÈáçÂ§ç', icon: '‚ö†Ô∏è' }
    ]
  }
  
  try {
    return [
      { key: 'all', label: t('popup.tabs.filterAll') || 'ÂÖ®ÈÉ®', icon: 'üìÑ' },
      { key: 'active', label: t('popup.tabs.filterActive') || 'Ê¥ªË∑É', icon: '‚óè' },
      { key: 'pinned', label: t('popup.tabs.filterPinned') || 'Âõ∫ÂÆö', icon: 'üìå' },
      { key: 'duplicate', label: t('popup.tabs.filterDuplicate') || 'ÈáçÂ§ç', icon: '‚ö†Ô∏è' }
    ]
  } catch (error) {
    return [
      { key: 'all', label: 'ÂÖ®ÈÉ®', icon: 'üìÑ' },
      { key: 'active', label: 'Ê¥ªË∑É', icon: '‚óè' },
      { key: 'pinned', label: 'Âõ∫ÂÆö', icon: 'üìå' },
      { key: 'duplicate', label: 'ÈáçÂ§ç', icon: '‚ö†Ô∏è' }
    ]
  }
})

// ËÆ°ÁÆóÂ±ûÊÄß  
const formatTime = computed(() => (timestamp: number) => {
  if (!isI18nReady.value) {
    if (!timestamp || timestamp === 0) return 'Êú™ÂêåÊ≠•'
    
    const now = Date.now()
    const diff = now - timestamp
    
    if (diff < 0) return 'ÂàöÂàöÂêåÊ≠•'
    if (diff < 60000) return 'ÂàöÂàöÂêåÊ≠•'
    if (diff < 3600000) return `${Math.floor(diff / 60000)} ÂàÜÈíüÂâç`
    if (diff < 86400000) return `${Math.floor(diff / 3600000)} Â∞èÊó∂Ââç`
    return `${Math.floor(diff / 86400000)} Â§©Ââç`
  }
  
  try {
    if (!timestamp || timestamp === 0) return t('popup.overview.notSynced') || 'Êú™ÂêåÊ≠•'
    
    const now = Date.now()
    const diff = now - timestamp
    
    if (diff < 0) return t('popup.overview.lastSync') || 'ÂàöÂàöÂêåÊ≠•' // Èò≤Ê≠¢Êú™Êù•Êó∂Èó¥
    if (diff < 60000) return t('popup.overview.lastSync') || 'ÂàöÂàöÂêåÊ≠•'
    if (diff < 3600000) return `${Math.floor(diff / 60000)} ${t('popup.overview.minutesAgo') || 'ÂàÜÈíüÂâç'}`
    if (diff < 86400000) return `${Math.floor(diff / 3600000)} ${t('popup.overview.hoursAgo') || 'Â∞èÊó∂Ââç'}`
    return `${Math.floor(diff / 86400000)} ${t('popup.overview.daysAgo') || 'Â§©Ââç'}`
  } catch (error) {
    return 'Êú™Áü•Êó∂Èó¥'
  }
})

const formatSnapshotTime = computed(() => (timestamp: number) => {
  // È™åËØÅÊó∂Èó¥Êà≥
  if (!timestamp || typeof timestamp !== 'number' || isNaN(timestamp) || timestamp <= 0) {
    return 'Êú™Áü•Êó∂Èó¥'
  }
  
  const date = new Date(timestamp)
  
  // Ê£ÄÊü•Êó•ÊúüÊòØÂê¶ÊúâÊïà
  if (isNaN(date.getTime())) {
    return 'Êó†ÊïàÊó•Êúü'
  }
  
  const now = new Date()
  const today = new Date(now.getFullYear(), now.getMonth(), now.getDate())
  const snapshotDate = new Date(date.getFullYear(), date.getMonth(), date.getDate())
  
  if (snapshotDate.getTime() === today.getTime()) {
    return `‰ªäÂ§© ${date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' })}`
  } else if (snapshotDate.getTime() === today.getTime() - 86400000) {
    return `Êò®Â§© ${date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' })}`
  } else {
    return date.toLocaleDateString('zh-CN', { month: 'numeric', day: 'numeric' }) + 
           ' ' + date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' })
  }
})

// Ê†áÁ≠æÈ°µÊéíÂ∫èÂíåËøáÊª§ÁöÑËÆ°ÁÆóÂ±ûÊÄß
const sortedAndFilteredTabs = computed(() => {
  let tabs = [...currentTabs.value]
  
  // ÂÖàËøáÊª§
  if (activeTabFilter.value !== 'all') {
    switch (activeTabFilter.value) {
      case 'active':
        tabs = tabs.filter(tab => tab.active)
        break
      case 'pinned':
        tabs = tabs.filter(tab => tab.pinned)
        break
      case 'duplicate':
        tabs = tabs.filter(tab => isDuplicate(tab))
        break
    }
  }
  
  // ÂÜçÊéíÂ∫è
  switch (tabSortMode.value) {
    case 'domain':
      tabs.sort((a, b) => {
        const domainA = getDomain(a.url)
        const domainB = getDomain(b.url)
        return domainA.localeCompare(domainB)
      })
      break
    case 'time':
      // ÊåâÁ¥¢ÂºïÊéíÂ∫èÔºàChromeÊ†áÁ≠æÈ°µÁ¥¢ÂºïÂèçÊò†‰∫ÜÂàõÂª∫Êó∂Èó¥È°∫Â∫èÔºâ
      tabs.sort((a, b) => (a.index || 0) - (b.index || 0))
      break
    case 'group':
      // ÂàÜÁªÑÊ®°Âºè‰∏ã‰∏çÈúÄË¶ÅÈ¢ùÂ§ñÊéíÂ∫èÔºåÂõ†‰∏∫‰ºöÁî®groupedTabs
      break
  }
  
  // Á°Æ‰øùÂõ∫ÂÆöÂíåÊ¥ªË∑ÉÊ†áÁ≠æÈ°µ‰ºòÂÖàÊòæÁ§∫
  tabs.sort((a, b) => {
    if (a.pinned && !b.pinned) return -1
    if (!a.pinned && b.pinned) return 1
    if (a.active && !b.active) return -1
    if (!a.active && b.active) return 1
    return 0
  })
  
  return tabs
})

const groupedTabs = computed(() => {
  const groups: { [key: string]: TabInfo[] } = {}
  
  currentTabs.value.forEach(tab => {
    const domain = getDomain(tab.url)
    if (!groups[domain]) {
      groups[domain] = []
    }
    groups[domain].push(tab)
  })
  
  return Object.entries(groups)
    .map(([domain, tabs]) => ({
      name: domain,
      tabs: tabs.sort((a, b) => {
        // Âú®ÁªÑÂÜÖÊåâÂõ∫ÂÆö„ÄÅÊ¥ªË∑É„ÄÅÁ¥¢ÂºïÊéíÂ∫è
        if (a.pinned && !b.pinned) return -1
        if (!a.pinned && b.pinned) return 1
        if (a.active && !b.active) return -1
        if (!a.active && b.active) return 1
        return (a.index || 0) - (b.index || 0)
      })
    }))
    .sort((a, b) => {
      // ÊåâÁªÑÂÜÖÊ†áÁ≠æÈ°µÊï∞ÈáèÊéíÂ∫è
      return b.tabs.length - a.tabs.length
    })
})

// Â≠òÂÇ®ÁõëÂê¨Âô®ÂºïÁî®‰ª•‰æøÊ∏ÖÁêÜ
let tabListeners: Array<() => void> = []

// ÁªÑ‰ª∂ÊåÇËΩΩÊó∂ÂàùÂßãÂåñ
onMounted(async () => {
  console.log('üöÄ Popup mounting...')
  
  // ÂàùÂßãÂåñÂ§öËØ≠Ë®Ä
  await initLanguage()
  isI18nReady.value = true
  
  // È¶ñÂÖàËÆæÁΩÆ‰∫ã‰ª∂ÁõëÂê¨Âô®
  setupEventListeners()
  
  // ÁõëÂê¨ËØ≠Ë®ÄÂèòÂåñÊ∂àÊÅØ
  setupLanguageListener()
  
  // ÁÑ∂ÂêéÂä†ËΩΩÊï∞ÊçÆ
  await loadData()
  
  // Ê£ÄÊµã‰∏ªÈ¢ò
  detectTheme()
  
  // ÊµãËØï‰∏ébackgroundÁöÑËøûÊé•
  testBackgroundConnection()
  
  console.log('‚úÖ Popup mounted successfully')
})

// ÊµãËØï‰∏ébackground scriptÁöÑËøûÊé•
function testBackgroundConnection() {
  try {
    console.log('üîó Testing connection to background script...')
    chrome.runtime.sendMessage({ type: 'ping' }, (response) => {
      if (chrome.runtime.lastError) {
        console.error('‚ùå Background connection failed:', chrome.runtime.lastError)
      } else {
        console.log('‚úÖ Background connection successful:', response)
      }
    })
  } catch (error) {
    console.error('‚ùå Failed to test background connection:', error)
  }
}

// ÁªÑ‰ª∂Âç∏ËΩΩÊó∂Ê∏ÖÁêÜÁõëÂê¨Âô®
onUnmounted(() => {
  tabListeners.forEach(cleanup => cleanup())
  tabListeners = []
})

// Âä†ËΩΩÊï∞ÊçÆ
async function loadData() {
  try {
    console.log('üîÑ Loading popup data...')
    
    // Âä†ËΩΩÊ†áÁ≠æÈ°µ
    const tabs = await chrome.tabs.query({})
    console.log('üìã Loaded', tabs.length, 'tabs')
    
    // Âº∫Âà∂Ëß¶ÂèëVueÂìçÂ∫îÊÄßÊõ¥Êñ∞
    const newTabsData = tabs.map(tab => ({
      id: tab.id,
      url: tab.url || '',
      title: tab.title || '',
      favicon: tab.favIconUrl,
      windowId: tab.windowId,
      index: tab.index,
      active: tab.active,
      pinned: tab.pinned
    }))
    
    // ÂÆåÂÖ®ÊõøÊç¢Êï∞ÁªÑ‰ª•Á°Æ‰øùVueÂìçÂ∫îÊÄß
    currentTabs.value.splice(0, currentTabs.value.length, ...newTabsData)
    console.log('üìù Updated currentTabs, new length:', currentTabs.value.length)

    // Âä†ËΩΩÂ∑•‰ΩúÁ©∫Èó¥
    const newWorkspaces = workspaceManager.getAllWorkspaces()
    workspaces.value.splice(0, workspaces.value.length, ...newWorkspaces)
    activeWorkspaceId.value = workspaceManager.getActiveWorkspace()?.id || null
    console.log('üè¢ Updated workspaces, count:', workspaces.value.length)

    // Âä†ËΩΩÈáçÂ§çÊ£ÄÊµã
    const duplicates = await duplicateDetector.detectAllDuplicates()
    const newDuplicateUrls = new Set(
      duplicates.flatMap(group => group.tabs.map(tab => tab.url))
    )
    duplicateTabs.value.clear()
    newDuplicateUrls.forEach(url => duplicateTabs.value.add(url))
    console.log('üîç Updated duplicates, count:', duplicateTabs.value.size)

    // Êõ¥Êñ∞ÁªüËÆ° - ÂàÜÂà´Êõ¥Êñ∞ÊØè‰∏™Â±ûÊÄß‰ª•Á°Æ‰øùÂìçÂ∫îÊÄß
    const workspaceStats = workspaceManager.getWorkspaceStats()
    
    const oldStats = { ...stats }
    
    // ÈÄê‰∏™Êõ¥Êñ∞statsÂ±ûÊÄß‰ª•Ëß¶ÂèëVueÂìçÂ∫îÊÄß
    const newTotalTabs = currentTabs.value.length
    const newDuplicateTabs = duplicateTabs.value.size
    const newTotalWorkspaces = workspaceStats.totalWorkspaces
    
    if (stats.totalTabs !== newTotalTabs) {
      stats.totalTabs = newTotalTabs
      console.log('üìä Updated totalTabs:', oldStats.totalTabs, '->', stats.totalTabs)
    }
    
    if (stats.duplicateTabs !== newDuplicateTabs) {
      stats.duplicateTabs = newDuplicateTabs
      console.log('üìä Updated duplicateTabs:', oldStats.duplicateTabs, '->', stats.duplicateTabs)
    }
    
    if (stats.totalWorkspaces !== newTotalWorkspaces) {
      stats.totalWorkspaces = newTotalWorkspaces
      console.log('üìä Updated totalWorkspaces:', oldStats.totalWorkspaces, '->', stats.totalWorkspaces)
    }
    
    console.log('üìä Final stats:', {
      totalTabs: stats.totalTabs,
      duplicateTabs: stats.duplicateTabs,
      totalWorkspaces: stats.totalWorkspaces
    })
    
    // Ëé∑ÂèñÂêåÊ≠•Êó∂Èó¥ÔºåÂ¶ÇÊûúÊ≤°ÊúâÂàô‰øùÊåÅ‰∏∫0
    try {
      const syncStats = await syncManager.getSyncStats()
      // ‰ºòÂÖà‰ΩøÁî® sync stats ‰∏≠ÁöÑÊó∂Èó¥ÔºåÂ¶ÇÊûú‰∏∫ 0 ÂàôËé∑ÂèñÊúÄÊñ∞Âø´ÁÖßÁöÑÊó∂Èó¥
      if (syncStats.lastSyncTime && syncStats.lastSyncTime > 0) {
        if (stats.lastSyncTime !== syncStats.lastSyncTime) {
          stats.lastSyncTime = syncStats.lastSyncTime
          console.log('üïí Updated lastSyncTime from syncStats:', stats.lastSyncTime)
        }
      } else {
        // Â∞ùËØï‰ªéÊúÄÊñ∞Âø´ÁÖßËé∑ÂèñÂêåÊ≠•Êó∂Èó¥
        const snapshots = await syncManager.getSnapshotList()
        if (snapshots.length > 0) {
          const snapshotTime = snapshots[0].timestamp
          if (stats.lastSyncTime !== snapshotTime) {
            stats.lastSyncTime = snapshotTime
            console.log('üïí Updated lastSyncTime from snapshot:', stats.lastSyncTime)
          }
        } else {
          if (stats.lastSyncTime !== 0) {
            stats.lastSyncTime = 0
            console.log('üïí Reset lastSyncTime to 0')
          }
        }
      }
    } catch (error) {
      console.warn('Failed to get sync stats:', error)
      if (stats.lastSyncTime !== 0) {
        stats.lastSyncTime = 0
      }
    }
    
    console.log('‚úÖ Popup data loaded and UI updated successfully')
    
    // Âº∫Âà∂VueÈáçÊñ∞Ê∏≤ÊüìÔºà‰Ωú‰∏∫ÊúÄÂêéÁöÑ‰øùÈöúÔºâ
    await nextTick()
    console.log('üîÑ Forced Vue to re-render')
    
  } catch (error) {
    console.error('‚ùå Error loading data:', error)
    showNotification('error', 'Êï∞ÊçÆÂä†ËΩΩÂ§±Ë¥•', 'ËØ∑Âà∑Êñ∞ÂêéÈáçËØï')
  }
}

// ËÆæÁΩÆ‰∫ã‰ª∂ÁõëÂê¨Âô®
function setupEventListeners() {
  // ÁõëÂê¨ÂëΩ‰ª§Èù¢ÊùøÂø´Êç∑ÈîÆ
  const handleCommandPalette = () => {
    showCommandPalette.value = true
  }
  window.addEventListener('open-command-palette', handleCommandPalette)
  tabListeners.push(() => window.removeEventListener('open-command-palette', handleCommandPalette))

  // ÁõëÂê¨ChromeÊâ©Â±ïÊ∂àÊÅØ
  const handleMessage = (message: any, sender: any, sendResponse: any) => {
    console.log('Popup received message:', message.type, message)
    
    switch (message.type) {
      case 'tab-created':
      case 'tab-updated':
      case 'tab-removed':
      case 'tab-activated':
      case 'window-created':
      case 'window-removed':
        console.log('üîÑ Refreshing popup data due to:', message.type)
        loadData()
        break
      case 'open-command-palette':
        showCommandPalette.value = true
        break
      case 'heartbeat':
        console.log('üíì Heartbeat received from background:', message.payload.timestamp)
        break
      case 'duplicate-notification-fallback':
        console.log('üîî Received duplicate notification fallback:', message.payload)
        showDuplicateNotificationInPopup(message.payload)
        break
      default:
        console.log('‚ùì Unhandled message type:', message.type)
    }
  }
  chrome.runtime.onMessage.addListener(handleMessage)
  tabListeners.push(() => chrome.runtime.onMessage.removeListener(handleMessage))

  // ÁõëÂê¨ÁÑ¶ÁÇπÂèòÂåñ‰ª•ÂÆûÊó∂Êõ¥Êñ∞Êï∞ÊçÆ
  const handleWindowFocus = () => {
    console.log('Window focus changed, refreshing data')
    loadData()
  }
  window.addEventListener('focus', handleWindowFocus)
  tabListeners.push(() => window.removeEventListener('focus', handleWindowFocus))

  // ÁõëÂê¨È°µÈù¢ÂèØËßÅÊÄßÂèòÂåñ
  const handleVisibilityChange = () => {
    if (!document.hidden) {
      console.log('Page became visible, refreshing data')
      loadData()
    }
  }
  document.addEventListener('visibilitychange', handleVisibilityChange)
  tabListeners.push(() => document.removeEventListener('visibilitychange', handleVisibilityChange))
}

// Ê£ÄÊµã‰∏ªÈ¢ò
async function detectTheme() {
  try {
    // Ëé∑ÂèñÁî®Êà∑ËÆæÁΩÆÁöÑ‰∏ªÈ¢ò
    const userSettings = await chrome.storage.sync.get(['settings'])
    const themeSettings = userSettings.settings?.ui?.theme || 'auto'
    
    const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)')
    
    function updateTheme() {
      switch (themeSettings) {
        case 'dark':
          isDarkMode.value = true
          break
        case 'light':
          isDarkMode.value = false
          break
        case 'auto':
        default:
          isDarkMode.value = mediaQuery.matches
          break
      }
      
      // Â∫îÁî®Âà∞ÊñáÊ°£Ê†πÂÖÉÁ¥†
      if (isDarkMode.value) {
        document.documentElement.classList.add('dark')
      } else {
        document.documentElement.classList.remove('dark')
      }
    }
    
    // Á´ãÂç≥Â∫îÁî®
    updateTheme()
    
    // ÁõëÂê¨Á≥ªÁªü‰∏ªÈ¢òÂèòÂåñ
    mediaQuery.addEventListener('change', updateTheme)
  } catch (error) {
    // Â¶ÇÊûúËé∑ÂèñËÆæÁΩÆÂ§±Ë¥•Ôºå‰ΩøÁî®Á≥ªÁªü‰∏ªÈ¢ò
    const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)')
    isDarkMode.value = mediaQuery.matches
    
    mediaQuery.addEventListener('change', (e) => {
      isDarkMode.value = e.matches
    })
  }
}

// Â∑•ÂÖ∑ÂáΩÊï∞
function truncateText(text: string, maxLength: number): string {
  return text.length > maxLength ? text.substring(0, maxLength) + '...' : text
}

function getDomain(url: string): string {
  try {
    return new URL(url).hostname
  } catch {
    return url
  }
}

function getFaviconUrl(favicon: string | undefined): string {
  // Â¶ÇÊûúÊ≤°ÊúâfaviconÊàñËÄÖfavicon‰∏∫Á©∫Ôºå‰ΩøÁî®ÈªòËÆ§ÂõæÊ†á
  if (!favicon || favicon.trim() === '') {
    return chrome.runtime.getURL('icons/default-favicon.png')
  }
  
  // Ê£ÄÊü•ÁºìÂ≠ò‰∏≠ÊòØÂê¶ÊúâËøô‰∏™faviconÁöÑÊàêÂäüÊõø‰ª£ÂìÅ
  if (faviconCache.has(favicon)) {
    return faviconCache.get(favicon)!
  }
  
  // Â¶ÇÊûúËøô‰∏™favicon‰πãÂâçÂ§±Ë¥•ËøáÔºåÁõ¥Êé•‰ΩøÁî®ÈªòËÆ§ÂõæÊ†á
  if (faviconErrors.has(favicon)) {
    const defaultUrl = chrome.runtime.getURL('icons/default-favicon.png')
    faviconCache.set(favicon, defaultUrl)
    return defaultUrl
  }
  
  // Â¶ÇÊûúfaviconÊòØdata URLÊàñËÄÖÊúâÊïàÁöÑhttp(s) URLÔºåÁõ¥Êé•‰ΩøÁî®
  if (favicon.startsWith('data:') || favicon.startsWith('http://') || favicon.startsWith('https://')) {
    return favicon
  }
  
  // Â¶ÇÊûúfaviconÊòØÁõ∏ÂØπË∑ØÂæÑÔºå‰πüÂ∞ùËØï‰ΩøÁî®ÔºàÊüê‰∫õÁΩëÁ´ôÂèØËÉΩÊúâÁâπÊÆäfaviconÔºâ
  return favicon
}

function isDuplicate(tab: TabInfo): boolean {
  return duplicateTabs.value.has(tab.url)
}

function getWorkspaceActivity(workspace: Workspace): number {
  // Âü∫‰∫éÊ†áÁ≠æÈ°µÊï∞ÈáèÂíåÊúÄËøëÊõ¥Êñ∞Êó∂Èó¥ËÆ°ÁÆóÊ¥ªË∑ÉÂ∫¶
  const tabCount = workspace.tabs.length
  const timeSinceUpdate = Date.now() - workspace.updatedAt
  const hoursSinceUpdate = timeSinceUpdate / (1000 * 60 * 60)
  
  let activity = Math.min(tabCount * 10, 100)
  if (hoursSinceUpdate > 24) activity *= 0.5
  if (hoursSinceUpdate > 168) activity *= 0.3 // ‰∏ÄÂë®
  
  return Math.max(0, Math.min(100, activity))
}

// Áî®‰∫éË∑üË∏™Â∑≤ÁªèÂ§±Ë¥•ÁöÑfavicon
const faviconErrors = new Set<string>()
// Áî®‰∫éÁºìÂ≠òÊàêÂäüÁöÑfavicon
const faviconCache = new Map<string, string>()

function handleFaviconError(event: Event) {
  const img = event.target as HTMLImageElement
  const originalSrc = img.src
  
  // Â¶ÇÊûúËøô‰∏™ÂõæÁâáÂ∑≤ÁªèÂ∞ùËØïËøáÈªòËÆ§favicon‰∫ÜÔºåÂ∞±‰∏çË¶ÅÂÜçÂ∞ùËØï‰∫Ü
  if (faviconErrors.has(originalSrc) || img.src.includes('default-favicon.png')) {
    console.log('üö´ Favicon loading failed, using fallback text icon')
    // ‰ΩøÁî®ÊñáÊú¨ÂõæÊ†á‰ª£Êõø
    img.style.display = 'none'
    
    // ÂàõÂª∫‰∏Ä‰∏™ÊñáÊú¨ÂõæÊ†áÊõø‰ª£
    const textIcon = document.createElement('div')
    textIcon.style.cssText = `
      width: 16px;
      height: 16px;
      background: #007AFF;
      border-radius: 2px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      font-weight: bold;
      color: white;
      flex-shrink: 0;
    `
    textIcon.textContent = 'üåê'
    
    // ÊõøÊç¢ÂéüÂßãÂõæÁâá
    if (img.parentNode) {
      img.parentNode.insertBefore(textIcon, img)
      img.remove()
    }
    return
  }
  
  // ËÆ∞ÂΩïËøô‰∏™URLÂ∑≤ÁªèÂ§±Ë¥•‰∫Ü
  faviconErrors.add(originalSrc)
  
  // Â∞ùËØï‰ΩøÁî®ÈªòËÆ§favicon
  try {
    img.src = chrome.runtime.getURL('icons/default-favicon.png')
    console.log('üîÑ Trying default favicon for failed URL:', originalSrc)
  } catch (error) {
    console.error('‚ùå Failed to load default favicon:', error)
    // ÊúÄÁªàÈôçÁ∫ßÔºöÈöêËóèÂõæÁâá
    img.style.display = 'none'
  }
}

// Ê†áÁ≠æÈ°µÊéíÂ∫èÂíåËøáÊª§Êìç‰Ωú
function toggleTabSort() {
  const modes: ('time' | 'domain' | 'group')[] = ['time', 'domain', 'group']
  const currentIndex = modes.indexOf(tabSortMode.value)
  const nextIndex = (currentIndex + 1) % modes.length
  tabSortMode.value = modes[nextIndex]
  console.log('üîÑ Tab sort mode changed to:', tabSortMode.value)
}

function setTabFilter(filterKey: 'all' | 'active' | 'pinned' | 'duplicate') {
  activeTabFilter.value = filterKey
  console.log('üîç Tab filter changed to:', filterKey)
}

function getFilteredTabsCount(filterKey: 'all' | 'active' | 'pinned' | 'duplicate'): number {
  switch (filterKey) {
    case 'all':
      return currentTabs.value.length
    case 'active':
      return currentTabs.value.filter(tab => tab.active).length
    case 'pinned':
      return currentTabs.value.filter(tab => tab.pinned).length
    case 'duplicate':
      return currentTabs.value.filter(tab => isDuplicate(tab)).length
    default:
      return 0
  }
}

// Êìç‰ΩúÂáΩÊï∞
async function switchToTab(tab: TabInfo) {
  if (tab.id) {
    await chrome.tabs.update(tab.id, { active: true })
    window.close()
  }
}

async function openCommandPalette() {
  showCommandPalette.value = true
}

async function openSettings() {
  await chrome.runtime.openOptionsPage()
}

async function handleDuplicate(tab: TabInfo) {
  try {
    const duplicates = await duplicateDetector.detectNewTabDuplicates(tab)
    if (duplicates.length > 0) {
      // ÊòæÁ§∫ÈáçÂ§çÂ§ÑÁêÜÁïåÈù¢
      showNotification('info', t('notifications.duplicateFound'), t('notifications.duplicateFoundMessage').replace('{count}', duplicates.length.toString()))
    }
  } catch (error) {
    showNotification('error', t('notifications.detectionFailed'), t('notifications.detectionFailedMessage'))
  }
}

async function addToWorkspace(tab: TabInfo) {
  try {
    if (workspaces.value.length === 0) {
      showNotification('info', t('notifications.noWorkspace'), t('notifications.noWorkspaceMessage'))
      return
    }

    // Â¶ÇÊûúÂè™Êúâ‰∏Ä‰∏™ÂàÜÁªÑÔºåÁõ¥Êé•Ê∑ªÂä†Âà∞ËØ•ÂàÜÁªÑ
    if (workspaces.value.length === 1) {
      await addTabToSpecificWorkspace(tab, workspaces.value[0])
      return
    }

    // Â§ö‰∏™ÂàÜÁªÑÊó∂ÔºåÊòæÁ§∫ÈÄâÊã©ÂØπËØùÊ°Ü
    showWorkspaceSelector(tab)
  } catch (error) {
    console.error('Error adding tab to workspace:', error)
    showNotification('error', t('notifications.addFailed'), t('notifications.addFailedMessage'))
  }
}

// Ê∑ªÂä†Áä∂ÊÄÅÁÆ°ÁêÜ
const showWorkspaceSelectorDialog = ref(false)
const selectedTabForWorkspace = ref<TabInfo | null>(null)

function showWorkspaceSelector(tab: TabInfo) {
  selectedTabForWorkspace.value = tab
  showWorkspaceSelectorDialog.value = true
}

async function addTabToSpecificWorkspace(tab: TabInfo, workspace: Workspace) {
  const tabToAdd = {
    id: tab.id,
    url: tab.url,
    title: tab.title,
    favicon: tab.favicon,
    addedAt: Date.now()
  }

  const success = await workspaceManager.addTabToWorkspace(workspace.id, tabToAdd)
  
  if (success) {
    // ÈáçÊñ∞Âä†ËΩΩÂ∑•‰ΩúÁ©∫Èó¥Êï∞ÊçÆËÄå‰∏çÊòØÊâãÂä®‰øÆÊîπÔºåÈÅøÂÖçÈáçÂ§ç
    const newWorkspaces = workspaceManager.getAllWorkspaces()
    workspaces.value.splice(0, workspaces.value.length, ...newWorkspaces)
    
    const successMessage = isI18nReady.value ? 
      t('popup.workspaces.notifications.addSuccessMessage').replace('{name}', workspace.name) : 
      `Â∑≤Ê∑ªÂä†Âà∞ "${workspace.name}"`
    showNotification('success', 
      isI18nReady.value ? t('popup.workspaces.notifications.addSuccess') : 'Ê∑ªÂä†ÊàêÂäü', 
      successMessage)
  } else {
    // Ê†áÁ≠æÂ∑≤Â≠òÂú®ÊàñÊ∑ªÂä†Â§±Ë¥•
    const message = isI18nReady.value ? 
      t('popup.workspaces.notifications.tabExistsMessage').replace('{title}', tab.title) : 
      `"${tab.title}" Â∑≤Âú®ÂàÜÁªÑ‰∏≠`
    showNotification('info', 
      isI18nReady.value ? t('popup.workspaces.notifications.tabExists') : 'Ê†áÁ≠æÈ°µÂ∑≤Â≠òÂú®', 
      message)
  }
}

async function selectWorkspaceForTab(workspace: Workspace) {
  if (selectedTabForWorkspace.value) {
    await addTabToSpecificWorkspace(selectedTabForWorkspace.value, workspace)
    showWorkspaceSelectorDialog.value = false
    selectedTabForWorkspace.value = null
  }
}

async function openWorkspace(workspace: Workspace) {
  try {
    await workspaceManager.openWorkspace(workspace.id)
    const successMessage = isI18nReady.value ? 
      t('popup.workspaces.notifications.workspaceOpenedMessage').replace('{count}', workspace.tabs.length.toString()) : 
      `ÊâìÂºÄ‰∫Ü ${workspace.tabs.length} ‰∏™Ê†áÁ≠æÈ°µ`
    showNotification('success', 
      isI18nReady.value ? t('popup.workspaces.notifications.workspaceOpened') : 'Â∑•‰ΩúÁ©∫Èó¥Â∑≤ÊâìÂºÄ', 
      successMessage)
    window.close()
  } catch (error) {
    showNotification('error', 
      isI18nReady.value ? t('popup.workspaces.notifications.openFailed') : 'ÊâìÂºÄÂ§±Ë¥•', 
      isI18nReady.value ? t('popup.workspaces.notifications.openFailedMessage') : 'Êó†Ê≥ïÊâìÂºÄÂ∑•‰ΩúÁ©∫Èó¥')
  }
}

async function editWorkspace(workspace: Workspace) {
  try {
    const promptText = isI18nReady.value ? 
      t('popup.workspaces.prompts.editName') : 
      'ËØ∑ËæìÂÖ•Êñ∞ÁöÑÂàÜÁªÑÂêçÁß∞Ôºö'
    const newName = prompt(promptText, workspace.name)
    if (!newName || newName.trim() === '') return // Áî®Êà∑ÂèñÊ∂àÊàñËæìÂÖ•‰∏∫Á©∫
    
    const trimmedName = newName.trim()
    if (trimmedName === workspace.name) return // ÂêçÁß∞Ê≤°ÊúâÊîπÂèò
    
    // Êõ¥Êñ∞Â∑•‰ΩúÁ©∫Èó¥ÂêçÁß∞
    await workspaceManager.updateWorkspace(workspace.id, { name: trimmedName })
    
    // Êõ¥Êñ∞Êú¨Âú∞Êï∞ÊçÆ
    workspace.name = trimmedName
    workspace.updatedAt = Date.now()
    
    const successMessage = isI18nReady.value ? 
      t('popup.workspaces.notifications.updateSuccessMessage').replace('{name}', trimmedName) : 
      `ÂàÜÁªÑÂêçÁß∞Â∑≤Êõ¥Êîπ‰∏∫ "${trimmedName}"`
    showNotification('success', 
      isI18nReady.value ? t('popup.workspaces.notifications.updateSuccess') : 'ÂàÜÁªÑÂ∑≤Êõ¥Êñ∞', 
      successMessage)
  } catch (error) {
    console.error('Error editing workspace:', error)
    showNotification('error', 
      isI18nReady.value ? t('popup.workspaces.notifications.updateFailed') : 'Êõ¥Êñ∞Â§±Ë¥•', 
      isI18nReady.value ? t('popup.workspaces.notifications.updateFailedMessage') : 'Êó†Ê≥ïÊõ¥Êñ∞ÂàÜÁªÑÂêçÁß∞')
  }
}

async function createWorkspace() {
  try {
    const promptText = isI18nReady.value ? 
      t('popup.workspaces.prompts.createName') : 
      'ËØ∑ËæìÂÖ•ÂàÜÁªÑÂêçÁß∞Ôºö'
    const defaultName = isI18nReady.value ? 
      t('popup.workspaces.prompts.defaultName').replace('{number}', (workspaces.value.length + 1).toString()) : 
      `ÂàÜÁªÑ ${workspaces.value.length + 1}`
    const name = prompt(promptText, defaultName)
    if (!name || name.trim() === '') return // Áî®Êà∑ÂèñÊ∂àÊàñËæìÂÖ•‰∏∫Á©∫
    
    const workspace = await workspaceManager.createWorkspace({
      name: name.trim(),
      icon: 'üìÅ',
      color: '#007AFF',
      tabs: []
    })
    
    // ÈáçÊñ∞Âä†ËΩΩÂ∑•‰ΩúÁ©∫Èó¥Êï∞ÊçÆËÄå‰∏çÊòØÊâãÂä®Êé®ÂÖ•ÔºåÈÅøÂÖçÈáçÂ§ç
    const newWorkspaces = workspaceManager.getAllWorkspaces()
    workspaces.value.splice(0, workspaces.value.length, ...newWorkspaces)
    
    showNotification('success', 
      isI18nReady.value ? t('popup.workspaces.notifications.createSuccess') : 'ÂàÜÁªÑÂ∑≤ÂàõÂª∫', 
      workspace.name)
  } catch (error) {
    showNotification('error', 
      isI18nReady.value ? t('popup.workspaces.notifications.createFailed') : 'ÂàõÂª∫Â§±Ë¥•', 
      isI18nReady.value ? t('popup.workspaces.notifications.createFailedMessage') : 'Êó†Ê≥ïÂàõÂª∫ÂàÜÁªÑ')
  }
}

async function syncNow() {
  try {
    const snapshot = await syncManager.createSnapshot('manual')
    if (snapshot) {
      stats.lastSyncTime = snapshot.timestamp
      showNotification('success', 
        isI18nReady.value ? t('popup.systemActions.notifications.syncCompleted') : 'ÂêåÊ≠•ÂÆåÊàê', 
        isI18nReady.value ? t('popup.systemActions.notifications.syncCompletedMessage') : '‰ºöËØùÂ∑≤‰øùÂ≠ò')
    } else {
      showNotification('error', 
        isI18nReady.value ? t('popup.systemActions.notifications.syncFailed') : 'ÂêåÊ≠•Â§±Ë¥•', 
        isI18nReady.value ? t('popup.systemActions.notifications.syncFailedMessage') : 'ËØ∑Á®çÂêéÈáçËØï')
    }
  } catch (error) {
    showNotification('error', 
      isI18nReady.value ? t('popup.systemActions.notifications.syncFailed') : 'ÂêåÊ≠•Â§±Ë¥•', 
      isI18nReady.value ? t('popup.systemActions.notifications.syncFailedMessage') : 'ËØ∑Á®çÂêéÈáçËØï')
  }
}

async function createSnapshot() {
  try {
    const snapshotPrefix = isI18nReady.value ? 
      t('popup.systemActions.snapshotNames.manualPrefix') : 
      'ÊâãÂä®Âø´ÁÖß'
    const snapshotName = `${snapshotPrefix}_${new Date().toLocaleString()}`
    const snapshot = await syncManager.createSnapshot('manual', snapshotName)
    if (snapshot) {
      showNotification('success', 
        isI18nReady.value ? t('popup.systemActions.notifications.snapshotCreated') : 'Âø´ÁÖßÂ∑≤ÂàõÂª∫', 
        snapshot.name)
    }
  } catch (error) {
    showNotification('error', 
      isI18nReady.value ? t('popup.systemActions.notifications.snapshotCreateFailed') : 'ÂàõÂª∫Â§±Ë¥•', 
      isI18nReady.value ? t('popup.systemActions.notifications.snapshotCreateFailedMessage') : 'Êó†Ê≥ïÂàõÂª∫Âø´ÁÖß')
  }
}

async function restoreSession() {
  try {
    const snapshots = await syncManager.getSnapshotList()
    if (snapshots.length === 0) {
      showNotification('info', 
        isI18nReady.value ? t('popup.systemActions.notifications.noSnapshots') : 'Ê≤°ÊúâÂø´ÁÖß', 
        isI18nReady.value ? t('popup.systemActions.notifications.noSnapshotsMessage') : 'Ê≤°ÊúâÂèØÊÅ¢Â§çÁöÑ‰ºöËØùÂø´ÁÖß')
      return
    }
    
    showSessionRestoreDialog(snapshots)
  } catch (error) {
    console.error('Error getting snapshots:', error)
    showNotification('error', 
      isI18nReady.value ? t('popup.systemActions.notifications.getSnapshotsFailed') : 'Ëé∑ÂèñÂ§±Ë¥•', 
      isI18nReady.value ? t('popup.systemActions.notifications.getSnapshotsFailedMessage') : 'Êó†Ê≥ïËé∑Âèñ‰ºöËØùÂø´ÁÖß')
  }
}

// ‰ºöËØùÊÅ¢Â§çÂØπËØùÊ°ÜÁä∂ÊÄÅ
const showRestoreDialog = ref(false)
const availableSnapshots = ref<any[]>([])

function showSessionRestoreDialog(snapshots: any[]) {
  availableSnapshots.value = snapshots.slice(0, 10) // ÈôêÂà∂ÊòæÁ§∫ÊúÄÊñ∞10‰∏™
  showRestoreDialog.value = true
}

async function restoreFromSnapshot(snapshot: any) {
  try {
    await syncManager.restoreSnapshot(snapshot.id)
    showRestoreDialog.value = false
    const successMessage = isI18nReady.value ?
      t('popup.systemActions.notifications.restoreSuccessMessage').replace('{name}', snapshot.name) :
      `Â∑≤ÊÅ¢Â§ç "${snapshot.name}" Âø´ÁÖß`
    showNotification('success', 
      isI18nReady.value ? t('popup.systemActions.notifications.restoreSuccess') : 'ÊÅ¢Â§çÊàêÂäü', 
      successMessage)
    window.close()
  } catch (error) {
    console.error('Error restoring snapshot:', error)
    showNotification('error', 
      isI18nReady.value ? t('notifications.restoreFailed') : 'ÊÅ¢Â§çÂ§±Ë¥•', 
      isI18nReady.value ? t('notifications.restoreFailedMessage') : 'Êó†Ê≥ïÊÅ¢Â§ç‰ºöËØùÂø´ÁÖß')
  }
}

async function cleanDuplicates() {
  try {
    const duplicates = await duplicateDetector.detectAllDuplicates()
    if (duplicates.length === 0) {
      showNotification('info', t('notifications.noCleanupNeeded'), t('notifications.noCleanupNeededMessage'))
      return
    }
    
    // ÊòæÁ§∫Ê∏ÖÁêÜÁ°ÆËÆ§ÂØπËØùÊ°Ü
    showDuplicateCleanupDialog(duplicates)
  } catch (error) {
    showNotification('error', t('notifications.detectionFailed'), t('notifications.detectionFailedMessage'))
  }
}

// Ê∑ªÂä†ÈáçÂ§çÊ∏ÖÁêÜÂØπËØùÊ°ÜÁä∂ÊÄÅ
const showCleanupDialog = ref(false)
const duplicateGroups = ref<any[]>([])

function showDuplicateCleanupDialog(duplicates: any[]) {
  duplicateGroups.value = duplicates
  showCleanupDialog.value = true
}

async function confirmCleanDuplicates() {
  try {
    let closedCount = 0
    
    for (const group of duplicateGroups.value) {
      // ‰øùÁïôÁ¨¨‰∏Ä‰∏™Ê†áÁ≠æÈ°µÔºåÂÖ≥Èó≠ÂÖ∂‰ΩôÁöÑ
      const tabsToClose = group.tabs.slice(1)
      
      for (const tab of tabsToClose) {
        try {
          await chrome.tabs.remove(tab.id)
          closedCount++
        } catch (error) {
          console.warn(`Failed to close tab ${tab.id}:`, error)
        }
      }
    }
    
    showCleanupDialog.value = false
    duplicateGroups.value = []
    
    if (closedCount > 0) {
      const successMessage = isI18nReady.value ?
        t('popup.cleanup.notifications.completedMessage').replace('{count}', closedCount.toString()) :
        `Â∑≤ÂÖ≥Èó≠ ${closedCount} ‰∏™ÈáçÂ§çÊ†áÁ≠æÈ°µ`
      showNotification('success', 
        isI18nReady.value ? t('popup.cleanup.notifications.completed') : 'Ê∏ÖÁêÜÂÆåÊàê', 
        successMessage)
      // ÈáçÊñ∞Âä†ËΩΩÊï∞ÊçÆ
      await loadData()
    } else {
      showNotification('info', 
        isI18nReady.value ? t('popup.cleanup.notifications.nothingClosed') : 'Êó†Ê≥ïÊ∏ÖÁêÜ', 
        isI18nReady.value ? t('popup.cleanup.notifications.nothingClosedMessage') : 'Ê≤°ÊúâÊàêÂäüÂÖ≥Èó≠‰ªª‰ΩïÊ†áÁ≠æÈ°µ')
    }
  } catch (error) {
    showNotification('error', 
      isI18nReady.value ? t('popup.cleanup.notifications.failed') : 'Ê∏ÖÁêÜÂ§±Ë¥•', 
      isI18nReady.value ? t('popup.cleanup.notifications.failedMessage') : 'Ê∏ÖÁêÜËøáÁ®ã‰∏≠Âá∫Áé∞ÈîôËØØ')
  }
}

function executeCommand(command: any) {
  // ÊâßË°åÂëΩ‰ª§
  showCommandPalette.value = false
  showNotification('info', 'ÊâßË°åÂëΩ‰ª§', command.title)
}

// Êñ∞Ê†áÁ≠æÈ°µÁõ∏ÂÖ≥ÂäüËÉΩ
async function createNewTab() {
  try {
    console.log('üöÄ Starting createNewTab function')
    
    // ÊèêÁ§∫Áî®Êà∑ËæìÂÖ•URL
    const promptText = isI18nReady.value ? 
      t('popup.tabActions.newTabPrompt') : 
      'ËØ∑ËæìÂÖ•Ë¶ÅÊâìÂºÄÁöÑÁΩëÂùÄÔºö'
    const defaultUrl = isI18nReady.value ? 
      t('popup.tabActions.newTabDefault') : 
      'https://'
    const url = prompt(promptText, defaultUrl)
    if (!url) {
      console.log('‚ùå User cancelled URL input')
      return // Áî®Êà∑ÂèñÊ∂à
    }
    
    // Ê£ÄÊü•URLÊ†ºÂºè
    let finalUrl = url
    if (!url.startsWith('http://') && !url.startsWith('https://') && !url.startsWith('chrome://')) {
      finalUrl = 'https://' + url
    }
    
    console.log('üîó Creating new tab with URL:', finalUrl)
    
    // ÂàõÂª∫‰∏¥Êó∂Ê†áÁ≠æÈ°µÂØπË±°Áî®‰∫éÈáçÂ§çÊ£ÄÊµã
    const tempTab: TabInfo = {
      id: undefined,
      url: finalUrl,
      title: finalUrl,
      favicon: undefined,
      windowId: undefined,
      index: 0,
      active: false,
      pinned: false
    }
    
    console.log('üîç Starting duplicate detection for:', tempTab)
    console.log('üìã Current tabs before detection:', currentTabs.value.length)
    
    // ‰ΩøÁî®ÈáçÂ§çÊ£ÄÊµãÂô®Ê£ÄÊü•ÊòØÂê¶Â≠òÂú®ÈáçÂ§çÈ°µÈù¢
    const duplicates = await duplicateDetector.detectNewTabDuplicates(tempTab)
    
    console.log('üéØ Duplicate detection completed. Found:', duplicates.length, 'duplicates')
    console.log('üìù Duplicate details:', duplicates)
    
    if (duplicates.length > 0) {
      console.log('‚ö†Ô∏è Duplicates found! Showing confirmation dialog...')
      
      // ÊûÑÂª∫ÈáçÂ§çÈ°µÈù¢‰ø°ÊÅØ
      const duplicateInfo = duplicates.map(tab => `"${tab.title || tab.url}"`).join('„ÄÅ')
      const message = isI18nReady.value ? 
        t('notifications.duplicateDialog').replace('{info}', duplicateInfo) :
        `‚ö†Ô∏è ÂèëÁé∞ÈáçÂ§çÈ°µÈù¢ÔºÅ\n\nÈáçÂ§çÈ°µÈù¢Ôºö${duplicateInfo}\n\n‚ùì ÊÇ®Â∏åÊúõÂ¶Ç‰ΩïÂ§ÑÁêÜÔºü\n\n‚úÖ ÁÇπÂáª"Á°ÆÂÆö"Ôºö‰ªçÁÑ∂ÊâìÂºÄÊñ∞Ê†áÁ≠æÈ°µ\n‚ùå ÁÇπÂáª"ÂèñÊ∂à"ÔºöÂàáÊç¢Âà∞Áé∞ÊúâÈ°µÈù¢`
      
      console.log('üì¢ Showing confirmation dialog:', message)
      const shouldCreateNew = confirm(message)
      console.log('üë§ User choice - Create new tab:', shouldCreateNew)
      
      if (!shouldCreateNew) {
        // ÂàáÊç¢Âà∞Á¨¨‰∏Ä‰∏™ÈáçÂ§çÈ°µÈù¢
        const firstDuplicate = duplicates[0]
        if (firstDuplicate.id) {
          console.log('üîÄ Switching to existing tab:', firstDuplicate.id)
          await chrome.tabs.update(firstDuplicate.id, { active: true })
          showNotification('info', 
            isI18nReady.value ? t('notifications.switchedToExisting') : 'Â∑≤ÂàáÊç¢Âà∞Áé∞ÊúâÈ°µÈù¢', 
            isI18nReady.value ? t('notifications.switchedToExistingMessage').replace('{title}', firstDuplicate.title || firstDuplicate.url) : `Â∑≤ÂàáÊç¢Âà∞Áé∞ÊúâÁöÑÊ†áÁ≠æÈ°µÔºö${firstDuplicate.title || firstDuplicate.url}`)
          window.close()
          return
        }
      }
    } else {
      console.log('‚úÖ No duplicates found, proceeding to create new tab')
    }
    
    // ÂàõÂª∫Êñ∞Ê†áÁ≠æÈ°µ
    console.log('üìÑ Creating new tab...')
    const newTab = await chrome.tabs.create({ url: finalUrl })
    console.log('‚úÖ New tab created successfully:', newTab)
    
    if (duplicates.length > 0) {
      const warningMessage = isI18nReady.value ? 
        t('popup.tabActions.notifications.duplicateTabWarningMessage').replace('{count}', duplicates.length.toString()) :
        `‚ö†Ô∏è Â∑≤ÊâìÂºÄÊñ∞Ê†áÁ≠æÈ°µÔºå‰ΩÜÊ£ÄÊµãÂà∞ ${duplicates.length} ‰∏™ÈáçÂ§çÈ°µÈù¢`
      showNotification('warning', 
        isI18nReady.value ? t('popup.tabActions.notifications.duplicateTabWarning') : 'Â∑≤ÂàõÂª∫ÈáçÂ§çÊ†áÁ≠æÈ°µ', 
        warningMessage)
    } else {
      showNotification('success', 
        isI18nReady.value ? t('popup.tabActions.notifications.newTabCreated') : 'Êñ∞Ê†áÁ≠æÈ°µÂ∑≤ÂàõÂª∫', 
        isI18nReady.value ? t('popup.tabActions.notifications.newTabCreatedMessage') : '‚úÖ Â∑≤ÊàêÂäüÊâìÂºÄÊñ∞ÁöÑÊ†áÁ≠æÈ°µ')
    }
    
    window.close()
  } catch (error) {
    console.error('‚ùå Error in createNewTab:', error)
    showNotification('error', 
      isI18nReady.value ? t('popup.tabActions.notifications.createFailed') : 'ÂàõÂª∫Â§±Ë¥•', 
      isI18nReady.value ? t('popup.tabActions.notifications.createFailedMessage') : '‚ùå Êó†Ê≥ïÂàõÂª∫Êñ∞Ê†áÁ≠æÈ°µÔºåËØ∑ÈáçËØï')
  }
}

async function duplicateCurrentTab() {
  try {
    const [currentTab] = await chrome.tabs.query({ active: true, currentWindow: true })
    if (currentTab && currentTab.url) {
      console.log('Duplicating current tab:', currentTab)
      
      // ÂàõÂª∫‰∏¥Êó∂Ê†áÁ≠æÈ°µÂØπË±°Áî®‰∫éÈáçÂ§çÊ£ÄÊµã
      const tempTab: TabInfo = {
        id: undefined,
        url: currentTab.url,
        title: currentTab.title || currentTab.url,
        favicon: currentTab.favIconUrl,
        windowId: undefined,
        index: 0,
        active: false,
        pinned: false
      }
      
      // Ê£ÄÊü•ÊòØÂê¶Â≠òÂú®ÈáçÂ§çÈ°µÈù¢
      const duplicates = await duplicateDetector.detectNewTabDuplicates(tempTab)
      console.log('Duplicate detection result for current tab:', duplicates)
      
      if (duplicates.length > 0) { // ÂåÖÂê´ÂΩìÂâçÊ†áÁ≠æÈ°µÊú¨Ë∫´
        const duplicateInfo = duplicates.map(tab => `"${tab.title || tab.url}"`).join('„ÄÅ')
        const message = isI18nReady.value ?
          t('popup.tabActions.duplicateDialog.message').replace('{info}', duplicateInfo) :
          `‚ö†Ô∏è Ê£ÄÊµãÂà∞ÈáçÂ§çÈ°µÈù¢ÔºÅ\n\nÂΩìÂâçÈ°µÈù¢‰∏é‰ª•‰∏ãÈ°µÈù¢ÈáçÂ§çÔºö\n${duplicateInfo}\n\n‚ùì ÊòØÂê¶‰ªçË¶ÅÂ§çÂà∂ÂΩìÂâçÊ†áÁ≠æÈ°µÔºü\n\n‚úÖ ÁÇπÂáª"Á°ÆÂÆö"ÔºöÂ§çÂà∂Ê†áÁ≠æÈ°µ\n‚ùå ÁÇπÂáª"ÂèñÊ∂à"Ôºö‰∏çÂ§çÂà∂`
        
        const shouldDuplicate = confirm(message)
        
        if (!shouldDuplicate) {
          showNotification('info', 
            isI18nReady.value ? t('popup.tabActions.notifications.operationCancelled') : 'Êìç‰ΩúÂ∑≤ÂèñÊ∂à', 
            isI18nReady.value ? t('popup.tabActions.notifications.operationCancelledMessage') : 'Â∑≤ÂèñÊ∂àÂ§çÂà∂ÈáçÂ§çÊ†áÁ≠æÈ°µ')
          return
        }
      }
      
      // ÂàõÂª∫ÈáçÂ§çÊ†áÁ≠æÈ°µ
      const newTab = await chrome.tabs.create({ url: currentTab.url })
      console.log('Tab duplicated:', newTab)
      
      if (duplicates.length > 0) {
        const warningMessage = isI18nReady.value ?
          t('popup.tabActions.notifications.duplicateTabCreatedMessage').replace('{count}', (duplicates.length + 1).toString()) :
          `‚ö†Ô∏è Â∑≤Â§çÂà∂Ê†áÁ≠æÈ°µÔºåÁé∞Âú®ÂÖ±Êúâ ${duplicates.length + 1} ‰∏™Áõ∏ÂêåÈ°µÈù¢`
        showNotification('warning', 
          isI18nReady.value ? t('popup.tabActions.notifications.duplicateTabCreated') : 'Â∑≤ÂàõÂª∫ÈáçÂ§çÊ†áÁ≠æÈ°µ', 
          warningMessage)
      } else {
        showNotification('success', 
          isI18nReady.value ? t('popup.tabActions.notifications.tabDuplicated') : 'Ê†áÁ≠æÈ°µÂ∑≤Â§çÂà∂', 
          isI18nReady.value ? t('popup.tabActions.notifications.tabDuplicatedMessage') : '‚úÖ Â∑≤ÊàêÂäüÂ§çÂà∂ÂΩìÂâçÊ†áÁ≠æÈ°µ')
      }
      
      window.close()
    } else {
      showNotification('error', 
        isI18nReady.value ? t('popup.tabActions.notifications.duplicateFailed') : 'Â§çÂà∂Â§±Ë¥•', 
        isI18nReady.value ? t('popup.tabActions.notifications.duplicateFailedNoTab') : '‚ùå Êó†Ê≥ïËé∑ÂèñÂΩìÂâçÊ†áÁ≠æÈ°µ‰ø°ÊÅØ')
    }
  } catch (error) {
    console.error('Error duplicating tab:', error)
    showNotification('error', 
      isI18nReady.value ? t('popup.tabActions.notifications.duplicateFailed') : 'Â§çÂà∂Â§±Ë¥•', 
      isI18nReady.value ? t('popup.tabActions.notifications.duplicateFailedMessage') : '‚ùå Êó†Ê≥ïÂ§çÂà∂ÂΩìÂâçÊ†áÁ≠æÈ°µÔºåËØ∑ÈáçËØï')
  }
}

async function closeTab(tab: TabInfo) {
  try {
    if (tab.id) {
      console.log('üóëÔ∏è Closing tab:', tab.title)
      await chrome.tabs.remove(tab.id)
      const successMessage = isI18nReady.value ?
        t('popup.tabActions.notifications.tabClosedMessage').replace('{title}', truncateText(tab.title, 20)) :
        `Â∑≤ÂÖ≥Èó≠ "${truncateText(tab.title, 20)}"`
      showNotification('success', 
        isI18nReady.value ? t('popup.tabActions.notifications.tabClosed') : 'Ê†áÁ≠æÈ°µÂ∑≤ÂÖ≥Èó≠', 
        successMessage)
      
      // ÊâãÂä®‰ªéÊú¨Âú∞ÂàóË°®‰∏≠ÁßªÈô§‰ª•Á´ãÂç≥Êõ¥Êñ∞UI
      const index = currentTabs.value.findIndex(t => t.id === tab.id)
      if (index > -1) {
        currentTabs.value.splice(index, 1)
        console.log('üìù Removed tab from local list, remaining:', currentTabs.value.length)
        
        // Êõ¥Êñ∞ÁªüËÆ°
        stats.totalTabs = currentTabs.value.length
      }
    }
  } catch (error) {
    console.error('‚ùå Error closing tab:', error)
    showNotification('error', 
      isI18nReady.value ? t('popup.tabActions.notifications.closeFailed') : 'ÂÖ≥Èó≠Â§±Ë¥•', 
      isI18nReady.value ? t('popup.tabActions.notifications.closeFailedMessage') : 'Êó†Ê≥ïÂÖ≥Èó≠Ê†áÁ≠æÈ°µ')
  }
}

function showDuplicateNotificationInPopup(payload: any) {
  try {
    const { tab, duplicates, message } = payload
    console.log('üîî Showing duplicate notification in popup:', payload)
    
    // ÊòæÁ§∫‰∏Ä‰∏™ÁâπÊÆäÁöÑÈáçÂ§çÈ°µÈù¢ÈÄöÁü•
    showNotification('warning', 'Ê£ÄÊµãÂà∞ÈáçÂ§çÈ°µÈù¢', message)
    
    // ÂêåÊó∂Âú®ÊéßÂà∂Âè∞Êèê‰æõËØ¶ÁªÜ‰ø°ÊÅØ
    console.log('‚ö†Ô∏è ÈáçÂ§çÈ°µÈù¢ËØ¶ÊÉÖ:')
    console.log('ÂΩìÂâçÈ°µÈù¢:', tab)
    console.log('ÈáçÂ§çÈ°µÈù¢:', duplicates)
    
    // ÂèØ‰ª•ËÄÉËôëÂú®ËøôÈáåÊ∑ªÂä†Êõ¥Â§öÁöÑUIÂèçÈ¶àÔºåÊØîÂ¶ÇÈ´ò‰∫ÆÊòæÁ§∫ÈáçÂ§çÁöÑÊ†áÁ≠æÈ°µ
    
  } catch (error) {
    console.error('‚ùå Error showing duplicate notification in popup:', error)
  }
}

function showNotification(type: NotificationType['type'], title: string, message?: string) {
  notification.value = {
    id: Date.now().toString(),
    type,
    title,
    message,
    duration: type === 'warning' ? 5000 : 3000 // Ë≠¶ÂëäÈÄöÁü•ÊòæÁ§∫Êõ¥ÈïøÊó∂Èó¥
  }
  
  const duration = notification.value.duration
  setTimeout(() => {
    notification.value = null
  }, duration)
}

// ËØ≠Ë®ÄÂàáÊç¢Â§ÑÁêÜ
async function handleLanguageToggle() {
  try {
    await toggleLanguage()
    showNotification('success', t('notifications.languageChanged'))
  } catch (error) {
    console.error('Error toggling language:', error)
    showNotification('error', 'Failed to switch language')
  }
}

// ËÆæÁΩÆËØ≠Ë®ÄÂèòÂåñÁõëÂê¨Âô®
function setupLanguageListener() {
  try {
    chrome.runtime.onMessage.addListener((message, sender, sendResponse) => {
      if (message.type === 'LANGUAGE_CHANGED') {
        console.log('Received language change message:', message.language)
        // Êõ¥Êñ∞ÂΩìÂâçËØ≠Ë®ÄÁä∂ÊÄÅÔºà‰∏çÈúÄË¶Å‰øùÂ≠òÔºåÂõ†‰∏∫ËÆæÁΩÆÈ°µÈù¢Â∑≤Áªè‰øùÂ≠ò‰∫ÜÔºâ
        currentLanguage.value = message.language
        // ÈáçÊñ∞ÂàùÂßãÂåñËØ≠Ë®Ä
        initLanguage()
      }
    })
  } catch (error) {
    console.log('Chrome runtime not available for language listener')
  }
}

function getSortButtonTitle() {
  try {
    // Á°Æ‰øùtabSortModeÊúâÂÄº
    const sortMode = tabSortMode.value || 'time'
    
    // Á°Æ‰øùtabSortLabelsÂíåÁõ∏Â∫îÁöÑÂ±ûÊÄßÂ≠òÂú®
    const sortLabels = tabSortLabels.value
    if (!sortLabels || typeof sortLabels !== 'object') {
      return 'ÂΩìÂâçÊéíÂ∫è: ÊéíÂ∫è'
    }
    
    const currentSortText = isI18nReady.value ? (t('popup.tabs.currentSort') || 'ÂΩìÂâçÊéíÂ∫è') : 'ÂΩìÂâçÊéíÂ∫è'
    const sortLabel = sortLabels[sortMode] || 'ÊéíÂ∫è'
    return `${currentSortText}: ${sortLabel}`
  } catch (error) {
    console.error('Error in getSortButtonTitle:', error)
    return 'ÂΩìÂâçÊéíÂ∫è: ÊéíÂ∫è' // ÈªòËÆ§Ê†áÈ¢ò
  }
}

// Êñ∞Â¢ûÔºöÊòæÁ§∫Â∑•‰ΩúÁ©∫Èó¥Ê†áÁ≠æÈ°µÂØπËØùÊ°Ü
const showWorkspaceTabsDialogVisible = ref(false)
const selectedWorkspaceForTabs = ref<Workspace | null>(null)

function showWorkspaceTabsDialog(workspace: Workspace) {
  selectedWorkspaceForTabs.value = workspace
  showWorkspaceTabsDialogVisible.value = true
}

async function removeTabFromWorkspace(workspace: Workspace, tab: TabInfo) {
  const confirmText = isI18nReady.value ?
    t('popup.workspaces.tabsDialog.removeConfirm').replace('{title}', tab.title) :
    `Á°ÆÂÆöË¶Å‰ªéÂàÜÁªÑ‰∏≠ÁßªÈô§ "${tab.title}" ÂêóÔºü`
  
  if (confirm(confirmText)) {
    const success = await workspaceManager.removeTabFromWorkspace(workspace.id, tab.url)
    if (success) {
      // ÈáçÊñ∞Âä†ËΩΩÂ∑•‰ΩúÁ©∫Èó¥Êï∞ÊçÆ
      const newWorkspaces = workspaceManager.getAllWorkspaces()
      workspaces.value.splice(0, workspaces.value.length, ...newWorkspaces)
      
      // Êõ¥Êñ∞ÂØπËØùÊ°Ü‰∏≠ÊòæÁ§∫ÁöÑÂ∑•‰ΩúÁ©∫Èó¥Êï∞ÊçÆ
      const updatedWorkspace = newWorkspaces.find(w => w.id === workspace.id)
      if (updatedWorkspace) {
        selectedWorkspaceForTabs.value = updatedWorkspace
      }
      
      const successMessage = isI18nReady.value ? 
        t('popup.workspaces.notifications.removeTabSuccessMessage').replace('{title}', tab.title) : 
        `Â∑≤‰ªéÂàÜÁªÑ‰∏≠ÁßªÈô§ "${tab.title}"`
      showNotification('success', 
        isI18nReady.value ? t('popup.workspaces.notifications.removeTabSuccess') : 'ÁßªÈô§ÊàêÂäü', 
        successMessage)
    } else {
      showNotification('error', 
        isI18nReady.value ? t('popup.workspaces.notifications.removeTabFailed') : 'ÁßªÈô§Â§±Ë¥•', 
        isI18nReady.value ? t('popup.workspaces.notifications.removeTabFailedMessage') : 'Êó†Ê≥ï‰ªéÂàÜÁªÑ‰∏≠ÁßªÈô§Ê†áÁ≠æ')
    }
  }
}

async function openTabFromWorkspace(tab: TabInfo) {
  try {
    // Â∞ùËØïÊâæÂà∞Áé∞ÊúâÁöÑÊ†áÁ≠æÈ°µ
    const tabs = await chrome.tabs.query({ url: tab.url })
    if (tabs.length > 0) {
      // Â¶ÇÊûúÊ†áÁ≠æÈ°µÂ∑≤Â≠òÂú®ÔºåÊøÄÊ¥ªÂÆÉ
      await chrome.tabs.update(tabs[0].id!, { active: true })
    } else {
      // Â¶ÇÊûú‰∏çÂ≠òÂú®ÔºåÂàõÂª∫Êñ∞Ê†áÁ≠æÈ°µ
      await chrome.tabs.create({ url: tab.url, active: true })
    }
    window.close()
  } catch (error) {
    showNotification('error', 
      isI18nReady.value ? t('popup.workspaces.notifications.openTabFailed') : 'ÊâìÂºÄÂ§±Ë¥•', 
      isI18nReady.value ? t('popup.workspaces.notifications.openTabFailedMessage') : 'Êó†Ê≥ïÊâìÂºÄÊ†áÁ≠æÈ°µ')
  }
}

function getWorkspaceDialogDescription() {
  if (!selectedWorkspaceForTabs.value) {
    return isI18nReady.value ? 
      (t('popup.workspaces.tabsDialog.description') || 'ÂàÜÁªÑÊ†áÁ≠æÈ°µ') : 
      'ÂàÜÁªÑÊ†áÁ≠æÈ°µ'
  }
  
  const name = selectedWorkspaceForTabs.value.name
  if (isI18nReady.value) {
    try {
      const template = t('popup.workspaces.tabsDialog.description') || 'ÂàÜÁªÑ "{name}" ‰∏≠ÁöÑÊ†áÁ≠æÈ°µ'
      return template.replace('{name}', name)
    } catch (error) {
      return `ÂàÜÁªÑ "${name}" ‰∏≠ÁöÑÊ†áÁ≠æÈ°µ`
    }
  } else {
    return `ÂàÜÁªÑ "${name}" ‰∏≠ÁöÑÊ†áÁ≠æÈ°µ`
  }
}

async function deleteWorkspace(workspace: Workspace) {
  const confirmTitle = isI18nReady.value ?
    t('popup.workspaces.notifications.deleteConfirm').replace('{name}', workspace.name) :
    `Á°ÆÂÆöË¶ÅÂà†Èô§ÂàÜÁªÑ "${workspace.name}" ÂêóÔºü`
  
  const confirmMessage = isI18nReady.value ?
    t('popup.workspaces.notifications.deleteConfirmMessage') :
    'Âà†Èô§ÂêéÂàÜÁªÑÂÜÖÁöÑÊâÄÊúâÊ†áÁ≠æÈ°µËÆ∞ÂΩïÂ∞Ü‰∏¢Â§±ÔºåÊ≠§Êìç‰ΩúÊó†Ê≥ïÊí§ÈîÄ„ÄÇ'
  
  const fullConfirmText = `${confirmTitle}\n\n${confirmMessage}`
  
  if (confirm(fullConfirmText)) {
    try {
      const success = await workspaceManager.deleteWorkspace(workspace.id)
      if (success) {
        // ÈáçÊñ∞Âä†ËΩΩÂ∑•‰ΩúÁ©∫Èó¥Êï∞ÊçÆ
        const newWorkspaces = workspaceManager.getAllWorkspaces()
        workspaces.value.splice(0, workspaces.value.length, ...newWorkspaces)
        
        const successMessage = isI18nReady.value ? 
          t('popup.workspaces.notifications.deleteSuccessMessage').replace('{name}', workspace.name) : 
          `ÂàÜÁªÑ "${workspace.name}" Â∑≤Âà†Èô§`
        showNotification('success', 
          isI18nReady.value ? t('popup.workspaces.notifications.deleteSuccess') : 'Âà†Èô§ÊàêÂäü', 
          successMessage)
      } else {
        showNotification('error', 
          isI18nReady.value ? t('popup.workspaces.notifications.deleteFailed') : 'Âà†Èô§Â§±Ë¥•', 
          isI18nReady.value ? t('popup.workspaces.notifications.deleteFailedMessage') : 'Êó†Ê≥ïÂà†Èô§ÂàÜÁªÑ')
      }
    } catch (error) {
      console.error('Error deleting workspace:', error)
      showNotification('error', 
        isI18nReady.value ? t('popup.workspaces.notifications.deleteFailed') : 'Âà†Èô§Â§±Ë¥•', 
        isI18nReady.value ? t('popup.workspaces.notifications.deleteFailedMessage') : 'Êó†Ê≥ïÂà†Èô§ÂàÜÁªÑ')
    }
  }
}

async function deleteSnapshot(snapshot: any) {
  const confirmTitle = isI18nReady.value ?
    t('popup.systemActions.notifications.deleteSnapshotConfirm').replace('{name}', snapshot.name) :
    `Á°ÆÂÆöË¶ÅÂà†Èô§Âø´ÁÖß "${snapshot.name}" ÂêóÔºü`
  
  const confirmMessage = isI18nReady.value ?
    t('popup.systemActions.notifications.deleteSnapshotConfirmMessage') :
    'Âà†Èô§ÂêéÂø´ÁÖßÂ∞ÜÊó†Ê≥ïÊÅ¢Â§çÔºåÊ≠§Êìç‰ΩúÊó†Ê≥ïÊí§ÈîÄ„ÄÇ'
  
  const fullConfirmText = `${confirmTitle}\n\n${confirmMessage}`
  
  if (confirm(fullConfirmText)) {
    try {
      const success = await syncManager.deleteSnapshot(snapshot.id)
      if (success) {
        // ÈáçÊñ∞Âä†ËΩΩÂø´ÁÖßÂàóË°®
        const newSnapshots = await syncManager.getSnapshotList()
        availableSnapshots.value = newSnapshots.slice(0, 10) // ÈôêÂà∂ÊòæÁ§∫ÊúÄÊñ∞10‰∏™
        
        const successMessage = isI18nReady.value ? 
          `Âø´ÁÖß "${snapshot.name}" Â∑≤Âà†Èô§` : 
          `Âø´ÁÖß "${snapshot.name}" Â∑≤Âà†Èô§`
        showNotification('success', 
          isI18nReady.value ? t('popup.systemActions.notifications.snapshotDeleted') : 'Âø´ÁÖßÂ∑≤Âà†Èô§', 
          successMessage)
      } else {
        showNotification('error', 
          isI18nReady.value ? t('popup.systemActions.notifications.deleteSnapshotFailed') : 'Âà†Èô§Â§±Ë¥•', 
          isI18nReady.value ? t('popup.systemActions.notifications.deleteSnapshotFailedMessage') : 'Êó†Ê≥ïÂà†Èô§Âø´ÁÖß')
      }
    } catch (error) {
      console.error('Error deleting snapshot:', error)
      showNotification('error', 
        isI18nReady.value ? t('popup.systemActions.notifications.deleteSnapshotFailed') : 'Âà†Èô§Â§±Ë¥•', 
        isI18nReady.value ? t('popup.systemActions.notifications.deleteSnapshotFailedMessage') : 'Êó†Ê≥ïÂà†Èô§Âø´ÁÖß')
    }
  }
}
</script>

